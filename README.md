# 零界点 · WindowAutomationControlTool

一个基于 **Python + PyQt5** 的 Windows 窗口自动化工具。  
支持多项目、多场景、多步骤编排，并且通过 **后台消息（PostMessage）** 操作目标窗口，不抢占鼠标和键盘，可在你正常使用电脑的同时自动执行任务。

> 项目名称：`WindowAutomationControlTool`  
> 程序名：**零界点**  

---

## ✨ 特性概览

- 🧱 **多项目管理**
  - 为不同应用窗口创建独立项目（例如：游戏、业务系统、工具软件）
  - 每个项目绑定一个目标窗口标题关键字
  - 支持多个项目同时后台运行

- 🎬 **场景识别**
  - 每个项目包含多个 “场景”（如：登录界面 / 主界面 / 结算界面）
  - 支持 **锚点（Anchor）局部模板匹配**：
    - 在窗口截图中选定一个按钮/图标/文字区域作为锚点小图
    - 自动计算该区域在窗口中的相对坐标（ROI）
    - 识别时只在 ROI 内做 `cv2.matchTemplate`，快速且稳定
  - 保留整图匹配作为兜底：为场景配置一张整图识别图片 + 阈值

- 🧩 **操作编排（Action）**
  - 支持以下操作类型：
    - 单击、双击、右键点击
    - 拖拽（起点 → 终点）
    - 键盘按键（支持组合键如 `ctrl+a`）
    - 文本输入（支持中文，优先剪贴板粘贴）
    - 等待（毫秒）
  - 坐标采用 **相对坐标（0 ~ 1）**，自动适配不同分辨率
  - 每个操作可单独启用/禁用，支持配置操作后延迟

- 🪟 **窗口预览与拾取**
  - 项目编辑页右侧支持目标窗口实时预览（不抢占焦点）
  - 在预览画面中点击拾取位置，自动计算相对坐标并生成点击操作
  - 可一键截图保存为场景识别图或锚点小图

- 🧠 **后台执行，不干扰鼠标键盘**
  - 使用 `PostMessage / SendMessage` 发送 `WM_LBUTTONDOWN/UP`、`WM_KEYDOWN/UP`、`WM_CHAR` 等消息
  - 不移动真实鼠标，不调用 `mouse_event` / `keybd_event`
  - 可以边用电脑边自动执行脚本，多项目可并行运行

- 🧭 **友好的交互体验**
  - 主页面：
    - 项目以卡片形式展示
    - **双击项目卡片** → 进入项目编辑
    - **长按项目卡片** → 弹出 “上移 / 下移项目” 菜单，调整项目顺序
    - 右侧“运行状态”区域展示所有运行中项目的进度和日志
  - 项目编辑页：
    - 场景列表：右键场景可 “上移 / 下移 / 禁用 / 删除”
    - 操作列表：**长按操作项** 弹出 “上移 / 下移” 菜单调整顺序

---

## 📁 目录结构

当前仓库的主要结构如下：

```bash
WindowAutomationControlTool/
├── core/
│   ├── __init__.py
│   ├── background_executor.py   # 后台执行（PostMessage 操作）
│   ├── execution_manager.py     # 多项目并行执行调度
│   ├── project_manager.py       # 项目的加载/保存/排序
│   ├── scene_manager.py         # 场景识别（锚点 + 整图）
│   └── window_manager.py        # 窗口枚举、查找、截图
│
├── data/
│   └── projects/                # 项目配置和场景/锚点图片（运行时生成）
│
├── models/
│   ├── __init__.py
│   ├── action.py                # Action：操作模型
│   ├── project.py               # Project：项目模型
│   └── scene.py                 # Scene + SceneAnchor：场景和锚点模型
│
├── ui/
│   ├── __init__.py
│   ├── home_page.py             # 主页：项目列表 & 运行状态
│   ├── main_window.py           # 主窗口：堆叠主页和项目页
│   ├── project_page.py          # 项目编辑页：场景/操作/预览
│   │
│   ├── dialogs/                 # 各种编辑对话框
│   │   ├── __init__.py
│   │   ├── action_dialog.py         # 编辑操作
│   │   ├── anchor_capture_dialog.py # 从窗口截图中框选锚点区域
│   │   ├── project_dialog.py        # 编辑项目属性
│   │   ├── scene_anchor_dialog.py   # 编辑锚点名称/阈值
│   │   └── scene_dialog.py          # 编辑场景（含整图/锚点管理）
│   │
│   └── widgets/                 # 可复用 UI 组件
│       ├── __init__.py
│       ├── action_item.py       # 操作列表项（长按排序）
│       ├── execution_panel.py   # 运行状态显示面板
│       └── project_card.py      # 项目卡片（双击进入、长按排序、折叠）
│
├── ico_256x256.ico              # 应用/安装程序图标（零界点）
├── main.py                      # 程序入口
├── main.exe                     # 示例/本地打包产物
├── README.md
└── requirements.txt
```

---

## 🧩 运行环境

- 操作系统：**Windows 10 / 11**
- Python：**3.8+**

### 安装依赖

```bash
pip install -r requirements.txt
```

`requirements.txt` 内容示例：

```txt
PyQt5>=5.15.0
pywin32>=305
pillow>=9.0.0
opencv-python>=4.5.0
numpy>=1.21.0
pyperclip>=1.8.0
```

---

## ▶️ 启动方式

```bash
cd WindowAutomationControlTool
python main.py 
& 
main.exe
```

启动后：

1. 在主页右上角点击「**+ 新建项目**」。
2. 在弹出的项目对话框中：
   - 输入项目名称（例如：自动登录、自动战斗）
   - 通过「刷新」选择当前系统中的某个窗口，或手动输入窗口标题关键字
   - 配置是否自动识别场景、循环执行等。
3. 在主页上 **双击项目卡片** 进入项目编辑页：
   - 右侧点击「开始预览」，确认已经连上目标窗口。
   - 左边创建场景，为场景截取整图或添加锚点。
   - 中间添加操作（可以用「拾取位置」从预览中选择坐标）。
4. 回到主页，在项目卡片上点击「▶ 运行」，观察右侧运行状态和日志。

---

## 🧠 场景识别：基于锚点的局部模板匹配

每个场景可以配置 0~N 个 “锚点（SceneAnchor）”：

- 在场景编辑对话框中点击「添加锚点」：
  1. 弹出当前目标窗口的全屏截图。
  2. 在截图上按下并拖动鼠标，框选一个区域（例如“开始战斗”按钮）。
  3. 程序自动截取该区域为一张小图，保存到项目的 `data/projects/{project_id}_images/` 目录。
  4. 自动计算该区域在整窗中的 ROI（相对坐标）。
  5. 弹出锚点属性对话框，配置锚点名称和匹配阈值。

识别流程在 `core/scene_manager.py` 中实现：

1. 截图当前目标窗口（不抢占焦点）。
2. 对每个场景的每个锚点：
   - 只在该锚点 ROI 对应的区域内做 `cv2.matchTemplate` 匹配。
   - 若匹配相似度 ≥ 该锚点的阈值，则认为该场景 **命中**。
3. 若多个场景都命中，以相似度最高的为准。
4. 若所有场景都不命中，再尝试使用整图识别；若仍未命中，回退到默认场景。

这样大大降低整图波动（弹窗、动画、轻微布局变化）造成的识别失败。

---

## 🖥️ 打包为单文件 EXE（可选）

使用 PyInstaller 打包（建议先确认本地运行正常）：

```bash
pip install pyinstaller

pyinstaller -F -w -i ico_256x256.ico main.py
```

- `-F`：打成单文件 exe
- `-w`：不显示控制台窗口
- `-i ico_256x256.ico`：使用项目图标

完成后，在 `dist/` 目录下会生成一个 `main.exe`，可以重命名为 `零界点.exe`。

> 注意：`data/projects` 中的项目配置和图片是外部数据，不会自动打入 exe 中。  
> 建议在发布/安装时把 `data/` 目录一并打包到安装目录。

---

## 📌 后续计划

- [ ] 操作录制器：实时记录鼠标/键盘操作转为脚本
- [ ] 更丰富的动作类型（条件判断、循环、变量）
- [ ] 导入/导出项目（便于分享和备份）
- [ ] 提供简单的脚本 API，让高级用户可编写自定义逻辑

---

如有 Bug 反馈、功能建议或希望参与开发，欢迎在 GitHub Issues 中交流。  
**零界点** 希望成为你稳定的 Windows 自动化“小助手”。😊

---